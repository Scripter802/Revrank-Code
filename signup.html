<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
    import { getDatabase, ref, set, update, get, query, orderByChild, equalTo, onValue, remove } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js";

    const SHOPIFY_API_KEY = '719a1498fa70ec83dbaeb14f152d5751';
    const SHOPIFY_REDIRECT_URI = 'https://revrank-api.onrender.com/shopify/callback';
    const SHOPIFY_SCOPES = 'read_orders';

    const firebaseConfig = {
        apiKey: "AIzaSyC_vyGHFYT3QjkUULZwHqL2p4PYjqVoLnE",
        authDomain: "revrank-d889f.firebaseapp.com",
        databaseURL: "https://revrank-d889f-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "revrank-d889f",
        storageBucket: "revrank-d889f.appspot.com",
        messagingSenderId: "715615705364",
        appId: "1:715615705364:web:523f3f60f1e83b2cb90a01",
        measurementId: "G-TW6MMTZTD2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    var nameInput = document.querySelector('#nameInput');
    var lastNameInput = document.querySelector('#lastNameInput');
    var emailInput = document.querySelector('#emailInput');
    var signUpButton = document.querySelector('#signUpButton');
    var IGSubmitBtn = document.querySelector('#igSubmitBtn');
    var IGskipBtn = document.querySelector('#igSkipBtn');
    var firstStepBtn = document.querySelector('#firstStepBtn');
    var shopifySetupBtn = document.querySelector('#shopifySetupBtn');
    var emailForm = document.querySelector('#email-form-2');
    var storeForm = document.querySelector('#storeInput');

    var passInput = document.querySelector('#passInput');
    var passInputC = document.querySelector('#passInputConfirm');
    
    document.querySelector('#firstDiv').style.display = 'flex';
    document.querySelector('#finalStep').style.display = 'none';
    document.querySelector('#secondStep').style.display = 'none';
    document.querySelector('#igStep').style.display = 'none';
    
    nameInput.value = '';
    lastNameInput.value = '';
    emailInput.value = '';
    passInput.value = '';
    passInputC.value = '';
    storeForm.value = '';

    emailForm.addEventListener('submit', handlerCallback, true);
    function handlerCallback(event) {
      event.preventDefault();
      event.stopPropagation();
    }

    storeForm.addEventListener('submit', handlerCallbackNew, true);
    function handlerCallbackNew(event) {
      event.preventDefault();
      event.stopPropagation();

      initiateShopifyAuth();
    }


    firstStepBtn.addEventListener('click', function() {

        console.log("step 1 click")
        console.log(document.querySelector('#nameInput').value )

        if(document.querySelector('#nameInput').value == false || document.querySelector('#lastNameInput').value == false)
        return;

        console.log("step 1 ENTER")


        document.querySelector('#firstDiv').style.display = 'none'
        document.querySelector('#secondStep').style.display = 'flex'

        document.querySelector('#nameSpan').innerText = nameInput.value + '!';
    });

    signUpButton.addEventListener('click', function() {
    var email = emailInput.value.toLowerCase();
    var pass = passInput.value;

    signUpButton.classList.add('button-pop');

    setTimeout(() => {
        signUpButton.classList.remove('button-pop');
    }, 200); 

    if(passInput.value != passInputC.value){
        document.querySelector('#errTxt').style.display = 'block';
        document.querySelector('#errTxt').innerText = "Passwords don't match";
        
        return;
    }

    var sanatizedEmail = email.replace(/\./g, ',');

    createUserWithEmailAndPassword(auth, email, pass)
    .then((userCredential) => {
        var user = userCredential.user;
        console.log('User registered:', user);

            generateUniqueID(db).then(uniqueID => {
            // Insert user with unique ID into database
            const userRef = ref(db, 'users/' + sanatizedEmail);
            set(userRef, {
                id: uniqueID,
                firstName: nameInput.value,
                lastName: lastNameInput.value,
                email: sanatizedEmail
            });

            document.querySelector('#secondStep').style.display = 'none'
            document.querySelector('#igStep').style.display = 'flex'
            //document.querySelector('#finalStep').style.display = 'flex'
        }).catch(error => {
            console.error('Error registering user:', error);
            // Handle error
        });
        })
        .catch((error) => {
            var errorCode = error.code;
            var errorMessage = error.message;

            // Mapping Firebase error codes to custom messages
            const errorMessages = {
                'auth/invalid-email': 'Invalid Email Address',
                'auth/weak-password': 'Weak Password',
                'auth/email-already-in-use': 'Email Already In Use',
                'auth/missing-password': 'Password Missing'
            };

            // Display a custom error message or the original Firebase error message
            const customErrorMessage = errorMessages[errorCode] || errorMessage;

            // Check if the error is due to an existing email
            if (errorCode === 'auth/email-already-in-use') {
                const userRef = ref(db, 'users/' + sanatizedEmail);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().totalRevenue === undefined) {
                        // User exists but totalRevenue is not set
                        // Delete the user from the authentication system
                        const userToDelete = auth.currentUser;
                        deleteUser(userToDelete).then(() => {
                            console.log('User deleted from auth system');
                            // Delete the user from the database
                            remove(userRef).then(() => {
                                console.log('User deleted from database');
                                // Create a new user with the new data
                                createUserWithEmailAndPassword(auth, email, pass)
                                    .then((userCredential) => {
                                        var user = userCredential.user;
                                        console.log('New user registered:', user);

                                        generateUniqueID(db).then(uniqueID => {
                                        // Insert user with unique ID into database
                                        const userRef = ref(db, 'users/' + sanatizedEmail);
                                        set(userRef, {
                                            id: uniqueID,
                                            firstName: nameInput.value,
                                            lastName: lastNameInput.value,
                                            email: sanatizedEmail
                                        });

                                        document.querySelector('#secondStep').style.display = 'none'
                                        document.querySelector('#igStep').style.display = 'flex'
                                        //document.querySelector('#finalStep').style.display = 'flex'
                                    }).catch(error => {
                                        console.error('Error registering user:', error);
                                        // Handle error
                                    });

                                        
                                    })
                                    .catch((newError) => {
                                        console.error('Error creating new user:', newError);
                                    });
                            }).catch((removeError) => {
                                console.error('Error deleting user from database:', removeError);
                            });
                        }).catch((deleteError) => {
                            console.error('Error deleting user from auth system:', deleteError);
                        });
                    } else {
                        // Display the error message
                        document.querySelector('#errTxt').style.display = 'block';
                        var cleanedMessage = customErrorMessage.replace('Firebase: ', '');
                        console.error('Error logging in:', errorCode, errorMessage);
                        document.querySelector('#errTxt').innerText = cleanedMessage;
                    }
                });
            } else {
                // Display the error message for other errors
                document.querySelector('#errTxt').style.display = 'block';
                var cleanedMessage = customErrorMessage.replace('Firebase: ', '');
                console.error('Error logging in:', errorCode, errorMessage);
                document.querySelector('#errTxt').innerText = cleanedMessage;
            }
        });

});

    IGSubmitBtn.addEventListener('click', function() {
        var instagramHandle = instagramInput.value.trim().replace('@', '');

        if (instagramHandle.includes(' ')) {
            document.querySelector('#errorTextIG').style.display = 'block';
            document.querySelector('#errorTextIG').innerText = "No spaces allowed in the handle";
        } else {
            document.querySelector('#errorTextIG').style.display = 'none';
            var sanatizedEmail = emailInput.value.toLowerCase().replace(/\./g, ',');
            const userRef = ref(db, 'users/' + sanatizedEmail);
            update(userRef, {
                instagram: instagramHandle
            }).then(() => {
                document.querySelector('#igStep').style.display = 'none';
                document.querySelector('#finalStep').style.display = 'flex';
            }).catch((error) => {
                console.error('Error updating user:', error);
            });
        }
    });

    igSkipBtn.addEventListener('click', function() {
        var sanatizedEmail = emailInput.value.toLowerCase().replace(/\./g, ',');
        const userRef = ref(db, 'users/' + sanatizedEmail);
        update(userRef, {
            instagram: 'none'
        }).then(() => {
            document.querySelector('#igStep').style.display = 'none';
            document.querySelector('#finalStep').style.display = 'flex';
        }).catch((error) => {
            console.error('Error updating user:', error);
        });
    });

    shopifySetupBtn.addEventListener('click', function() {
        
        shopifySetupBtn.classList.add('button-pop');

        setTimeout(() => {
            shopifySetupBtn.classList.remove('button-pop');
        }, 200); 

        initiateShopifyAuth();
    });



    
    function initiateShopifyAuth() {
    var shopName = document.querySelector('#shopnameInput').value.trim().toLowerCase();
    if (!shopName) return;

    if (shopName.includes(' ')) {
        document.querySelector('#errorText').style.display = 'block';
        document.querySelector('#errorText').innerText = "Shop name cannot contain spaces";
        return;
    }

    shopName = shopName.replace(/\.myshopify\.com$/, '');

    const shopifyTokensRef = ref(db, 'shopifyTokens');
    const usedShopName = query(shopifyTokensRef, orderByChild('shopName'), equalTo(shopName));

    // Create a promise to handle the asynchronous Firebase query
    const checkExistingStore = new Promise((resolve) => {
        onValue(usedShopName, (snapshot) => {
            let existingShopData = null;
            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    existingShopData = { owner: childSnapshot.val().owner, ...childSnapshot.val() };
                });
                resolve(existingShopData);
            } else {
                resolve(null);
            }
        });
    });

    // Check if the shop already exists and handle it accordingly
    checkExistingStore.then((existingShopData) => {
        if (existingShopData) {
            document.querySelector('#errorText').style.display = 'block';
            document.querySelector('#errorText').innerText = "Shop Already In Use";
        } else {
            updateShopNameForCurrentUser(shopName);
        }
    });
}

    function updateShopNameForCurrentUser(shopName) {
        const user = auth.currentUser;
        if (user) {
            var sanitizedEmail = user.email.replace(/\./g, ',');
            const authURL = `https://${shopName}.myshopify.com/admin/oauth/authorize?client_id=${SHOPIFY_API_KEY}&scope=${SHOPIFY_SCOPES}&redirect_uri=${SHOPIFY_REDIRECT_URI}`;
            window.location.href = authURL;
        } else {
            console.error('No user is logged in.');
        }
    }

    //----------------------
    
    function generateRandomID() {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const charactersLength = characters.length;
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    function generateUniqueID(db) {
        const generateAndCheck = () => {
            const id = generateRandomID();
            return checkIDUniqueness(db, id).then(isUnique => {
                if (isUnique) {
                    return id; // Return the unique ID
                } else {
                    console.warn('Generated ID is not unique. Regenerating...');
                    return generateAndCheck(); // Retry generation
                }
            });
        };
        return generateAndCheck();
    }

    function checkIDUniqueness(db, id) {
        const userRef = ref(db, 'users');
        return get(userRef).then(snapshot => {
            if (snapshot.exists()) {
                const users = snapshot.val();
                for (const key in users) {
                    if (users.hasOwnProperty(key) && users[key].id === id) {
                        return false; // ID already exists
                    }
                }
            }
            return true; // ID is unique
        }).catch(error => {
            console.error('Error checking ID uniqueness:', error);
            return false; // Assume non-unique to prevent data corruption
        });
    }



</script>

