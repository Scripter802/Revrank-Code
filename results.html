<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/Scripter802/Revrank-Code/results-rank-visual.js"></script>
   
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
    import { getDatabase, ref, set, update, orderByChild, query, equalTo, onValue } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_vyGHFYT3QjkUULZwHqL2p4PYjqVoLnE",
        authDomain: "revrank-d889f.firebaseapp.com",
        databaseURL: "https://revrank-d889f-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "revrank-d889f",
        storageBucket: "revrank-d889f.appspot.com",
        messagingSenderId: "715615705364",
        appId: "1:715615705364:web:523f3f60f1e83b2cb90a01",
        measurementId: "G-TW6MMTZTD2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    $('#mobilePopup').css('display', 'none');

    document.addEventListener("DOMContentLoaded", function () {
    var urlParamsShopName = new URLSearchParams(window.location.search);
    var shopNameUsed = urlParamsShopName.get('shopName');

    if(shopNameUsed == null){
        window.location.href = 'https://www.revrank.io/login';
    }

    shopNameUsed = shopNameUsed.replace(',myshopify,com','')

    const thresholds = [
    { rank: 'Pawn', value: 25000 },
    { rank: 'Bishop', value: 50000 },
    { rank: 'Knight', value: 100000 },
    { rank: 'Rook', value: 250000 },
    { rank: 'Queen', value: 500000 },
    { rank: 'King', value: 1000000 }
    ];

    if (shopNameUsed) {
        console.log("got shop")
        const usersRef = ref(db, 'users');
        const emailQuery = query(usersRef, orderByChild('shopName'), equalTo(shopNameUsed));

        onValue(emailQuery, (snapshot) => {
            if (snapshot.exists()) {
                console.log("snapshop exists! ")
                const userDataObject = snapshot.val();
                const userId = Object.keys(userDataObject)[0];
                const userData = userDataObject[userId];
    
                var rankParam, imageURL, firstNameParam, igHandleParam, gotImageFromServer = false;

                const urlParams = new URLSearchParams(window.location.search);
                const totalRevenueParam = urlParams.get('totalRevenue');

                findUserRank(shopNameUsed, function(rankOfUser) {
                    if (rankOfUser !== null) {
                        $('#rankTextBig').text('You are ranked #' + rankOfUser + ' in the Revrank Leaderboard');
                    } else {
                        $('#rankTextBig').text('Rank not found');
                    }
                });


                userData.totalRevenue = totalRevenueParam;
                if (totalRevenueParam >= thresholds[thresholds.length - 1].value) {
                rankParam = thresholds[thresholds.length - 1].rank;
                } else {
                    for (const threshold of thresholds) {
                        if (totalRevenueParam < threshold.value) {
                            rankParam = threshold.rank;
                            break;
                        }
                    }
                }
                firstNameParam = userData.firstName;
                igHandleParam = userData.instagram;

                console.log("sending IG: " + igHandleParam)


                fetch('https://revrank-image-gen.onrender.com/generate-image', {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ rank: rankParam, firstName: firstNameParam, igHandle: igHandleParam, revenue: totalRevenueParam}),
                    })
                    .then(response => response.blob())
                    .then(blob => {
                        imageURL = URL.createObjectURL(blob);
                        gotImageFromServer = true;

                        if ((/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream)) {
                            $('#imageFromServer').attr('src', imageURL);
                        } else if (/Mac/.test(navigator.platform) || /Win/.test(navigator.platform)) {
                            $('#desktopImg_preview').attr('src', imageURL);
                        } else {
                            const downloadLink = document.createElement('a');
                            downloadLink.href = imageURL;
                            downloadLink.download = 'rank.png';
                            downloadLink.id = 'androidIMG'; 
                            document.body.appendChild(downloadLink);  
                        }

                }).catch(error => console.error('Error:', error));

                var fullShopName = shopNameUsed + ",myshopify,com";

                update(ref(db, 'shopifyTokens/' + fullShopName), { owner: userData.email }).then(() => {
                })

                update(ref(db, 'users/' + userId), { totalRevenue: totalRevenueParam }).then(() => {
                   // urlParams.delete('totalRevenue');
                    const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
                    window.history.replaceState({}, document.title, newUrl);

                    urlParams.delete('shopName');
                    const newUrl2 = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
                    window.history.replaceState({}, document.title, newUrl2);
                })

                document.querySelector('#firstNameTxt').innerText = userData.firstName;

                setTimeout(function() {
                    $('#loadingDiv').css('display', 'none');

                    if((/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) == false)
                    confetti({ particleCount: 350, spread: 300, origin: { x: .5, y: .2 } });
                }, 2000); 


            document.querySelectorAll('.sharingbutton').forEach(function(button) {
                button.addEventListener('click', function() {

                    if ((/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream)){

                        if (gotImageFromServer) {

                            $('#mobilePopup').css('display', 'flex');

                            $('.sharingbutton').each(function() {
                                let buttonChildren = $(this).children();
                                SharingBtn_load(buttonChildren);
                            });
                        } else {

                            
                            const intervalId = setInterval(() => {
                                if (gotImageFromServer) {
                                    clearInterval(intervalId);
                                    document.getElementById('mobilePopup').style.display = 'flex';
                                }
                            }, 150); 

                            document.querySelectorAll('.sharingbutton').forEach(function(sharingButton) {
                            let buttonChildren = sharingButton.children;
                            SharingBtn_load(buttonChildren);
                            });
                        }
                    }else{
                        if(/Mac/.test(navigator.platform) || /Win/.test(navigator.platform)){
                            if(gotImageFromServer){

                            document.getElementById('desktop_popup').style.display = 'flex';
                            document.querySelectorAll('.sharingbutton').forEach(function(sharingButton) {
                                let buttonChildren = sharingButton.children;
                                SharingBtn_load(buttonChildren);
                            });

                            }else{

                                const intervalId = setInterval(() => {
                                if (gotImageFromServer) {
                                    clearInterval(intervalId);
                                    document.getElementById('desktop_popup').style.display = 'flex';
                                }
                                }, 150); 

                                document.querySelectorAll('.sharingbutton').forEach(function(sharingButton) {
                                let buttonChildren = sharingButton.children;
                                SharingBtn_load(buttonChildren);
                            });
                            }
                        }else{
    
                            if(gotImageFromServer){
                                var downloadLink = document.getElementById('androidIMG')
                                downloadLink.click();
                                window.URL.revokeObjectURL(imageURL);
                                document.body.removeChild(downloadLink);

                                setTimeout(function(){
                                    window.location.href = 'intent://instagram.com/a/r/#Intent;package=com.instagram.android;scheme=https;end';
                                }, 1000);
                                
                            }else{
                                const intervalId = setInterval(() => {
                                    if (gotImageFromServer) {
                                            clearInterval(intervalId);

                                            var downloadLink = document.getElementById('androidIMG')
                                            downloadLink.click();
                                            window.URL.revokeObjectURL(imageURL);
                                            document.body.removeChild(downloadLink);

                                            setTimeout(function(){
                                                window.location.href = 'intent://instagram.com/a/r/#Intent;package=com.instagram.android;scheme=https;end';
                                            }, 1000);

                                            document.querySelectorAll('.sharingbutton').forEach(function(sharingButton) {
                                            let buttonChildren = sharingButton.children;
                                            SharingBtn_unload(buttonChildren);
                                        });

                                        }
                                    }, 150);
                                document.querySelectorAll('.sharingbutton').forEach(function(sharingButton) {
                                    let buttonChildren = sharingButton.children;
                                    SharingBtn_load(buttonChildren);
                                });
                            }
                    }
                    
                    }
                });
            });

            document.getElementById('realShareButton').addEventListener('click', function() {           
                setTimeout(function() {
                    window.location.href = 'instagram://story-camera';
                }, 1000);            
            })

            document.getElementById('copy_btn').addEventListener('click', function() {  
                var copyBtn = document.getElementById('copy_btn');
                const image = new Image();
                image.src = imageURL;

                image.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0);

                    canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                    .then(() => {
                        copyBtn.style.backgroundColor = '#73a951';
                        copyBtn.style.border = 'none'
                        copyBtn.children[0].innerText = "Copied!"
                    })
                    .catch(err => {

                        copyBtn.style.backgroundColor = 'red';
                        copyBtn.style.border = 'none'
                        copyBtn.innerText = "Error"
                    });
                }, 'image/png');
                };
            })

            document.getElementById('share_x').addEventListener('click', function() {      
                const text = "I’m a verified " + rankParam + ". Numbers don't lie";
               // const text = "Just got my rank on RevRank. I am a " + rankParam + ". Visit revrank.io to get your rank!";
                const hashtags = "rankreveal"; 
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&hashtags=${encodeURIComponent(hashtags)}`;
                window.open(twitterUrl, '_blank');         
            })

            document.getElementById('closeButtonPopup').addEventListener('click', function() {
                document.getElementById('mobilePopup').style.display = 'none';

                document.querySelectorAll('.sharingbutton').forEach(function(sharingButton) {
                    let buttonChildren = sharingButton.children;
                    SharingBtn_unload(buttonChildren);
                });
            });

            $('#closeButtonPopup_desktop').click(function() {
                $('#desktop_popup').css('display', 'none');

                $('.sharingbutton').each(function() {
                    let buttonChildren = $(this).children();
                    SharingBtn_unload(buttonChildren);
                });
            });

            
        } else {
                console.log('No user with email.');
            }
        });
    } else {
        console.log('No email in storage.');
    }
});


function SharingBtn_load(buttonC){
    for (let child of buttonC) {
        if (!child.classList.contains('buttonloading')) {
            child.style.display = 'none';
        }else{
            child.style.display = 'block';
        }
    }
}

function SharingBtn_unload(buttonC){
    for (let child of buttonC) {
        if (child.classList.contains('buttonloading')) {
            child.style.display = 'none';
        }else{
            child.style.display = 'block';
        }
    }
}



function findUserRank(shopNameUsed, callback) {
    const usersRef = ref(db, 'users');
    onValue(usersRef, (snapshot) => {
        if (snapshot.exists()) {
            const usersData = snapshot.val();
            const sortedUsers = Object.values(usersData)
                .filter(user => user.totalRevenue !== "undefined" && user.totalRevenue !== undefined)
                .sort((a, b) => parseFloat(b.totalRevenue) - parseFloat(a.totalRevenue));
            const userRank = sortedUsers.findIndex(user => user.shopName?.toLowerCase() === shopNameUsed.toLowerCase()) + 1; 
            callback(userRank);
        } else {
            console.log('No users found.');
            callback(null); 
        }
    });
}


</script>

<style>
    .confetti_canvas {
        position: absolute;
        width: 100vw;
        height: 100vh;
    }
</style>